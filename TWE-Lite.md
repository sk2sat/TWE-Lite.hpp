# TWE-Lite(App_UART)

## 動作モード

- インタラクティブモード
	- "+"を0.2~1.0秒空けて入力するとこのモードに移行
	- 設定変更ができる
- チャットモード
	- パソコンでなんも考えずに通信できる
	- 1行のテキストを送受信(CRLFが来たら送信)
	- プロンプトを表示
- 透過モード
	- プロンプト無し
	- ブロードキャスト
	- タイムアウト,トリガー文字,指定バイトに達した時に送信
	- 送信元区別不可
- 書式モード
	- 自分で色々設定してパケットを送る
	- アスキー形式とバイナリ形式がある

## 書式モード

実際のパケット構造は以下

[形式ヘッダ][送信コマンド(ascii/binary)][終端]

### 送信コマンド(簡易形式)

- 送信

|バイト数|内容|
|-|-|
|1|送信先論理ID|
|1|コマンド種別(0x80未満で任意)|
|N|送信バイト列|

- 受信

|バイト数|内容|
|-|-|
|1|送信元論理ID|
|1|コマンド種別(送信した値．0x80未満)|
|N|受信バイト列|

- 論理ID
	- 送信時
		- 0x00 親機
		- 0x01~0x64 子機
		- 0x78 全子機
	- 受信時
		- 0x00 親機
		- 0x01~0x64 子機
		- 0x78 子機(論理ID未設定)

### 送信コマンド(拡張形式)

- 送信

|バイト数|内容|
|-|-|
|1|送信先論理ID|
|1|0xA0|
|1|応答ID|
|0 or 4|拡張アドレス(ビッグエンディアン，指定時のみ)．通常0バイト．|
|1 or N|オプション列．指定しない場合0xFF．|
|N|送信バイト列|

- 受信

|バイト数|内容|
|-|-|
|1|論理ID|
|1|0xA0|
|1|応答ID|
|4|送信元拡張アドレス(ビッグエンディアン)|
|4|送信先拡張アドレス(ビッグエンディアン)．論理IDで送信時0xFFFFFFFF|
|1|通信品質LQI値．0が弱く255が強い．|
|2|受信バイト列サイズ(ビッグエンディアン)|
|N|受信バイト列|

- 論理ID
	- 送信時
		- 0x00 親機
		- 0x01~0x64 子機
		- 0x78 全子機
		- 0x80 拡張アドレス
	- 受信時
		- 0x00 親機
		- 0x01~0x64 子機
		- 0x78 子機(論理ID未設定)

### アスキー形式

|バイト数|内容|
|-|-|
|1|0x3A(':')|
|2N|データ部(送信コマンドascii形式)|
|2|チェックサム|
|2|フッタ．CRLF(0x0D, 0x0A)|

- データ部のascii化
	- 1バイトをascii文字2文字で表現(A-Fは大文字)
	- 0x1F は '1F' (0x31, 0x46)

- チェックサム
	- データ部(バイナリ)の各バイトの和を8bit幅で計算し2の補数をとる
	- データ部の各バイトの総和 + チェックサム = 0
	- これもascii

- 省略表現
	- チェックサムとフッタを省略し'X'を指定できる
	- 送信時に限る(TWE-Liteがよしなにやってくれる)

### バイナリ形式

|バイト数|内容|
|-|-|
|2|0xA5, 0x5A|
|2|データ長(ビッグエンディアン)|
|N|データ部(送信コマンドそのまま)|
|1|チェックサム|
|0(1)|フッタ|

- データ長
	- MSB(0x8000)を設定
	- 0x8000 + N

- チェックサム
	- データ部の各バイトのXOR

- フッタ
	- チェックサムが事実上の終端
	- 実際の出力では0x04(EOT)が付加される

## リンク

- [インタラクティブモード](https://mono-wireless.com/jp/products/TWE-APPS/App_Uart/interactive.html)
- [書式モード](https://mono-wireless.com/jp/products/TWE-APPS/App_Uart/mode_format.html)
- [0xDBコマンド](https://mono-wireless.com/jp/products/TWE-APPS/App_Uart/func_DB_command.html)
